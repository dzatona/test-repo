name: Thunderwind Publish Manifest
on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-manifest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'

      - name: Compute measurement
        id: measurement
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          echo "Building Go application"
          CGO_ENABLED=0 go build -trimpath -buildvcs=false -ldflags "-buildid=" -o app main.go

          if [ ! -f "app" ]; then
            echo "Error: Go build did not produce binary"
            exit 1
          fi

          MEASUREMENT=$(sha256sum app | awk '{print $1}')
          TEE_TARGET="tdx"

          # Export to GitHub output
          echo "measurement=$MEASUREMENT" >> $GITHUB_OUTPUT
          echo "tee_target=$TEE_TARGET" >> $GITHUB_OUTPUT
          echo "Computed measurement: $MEASUREMENT"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-binary
          path: app
          if-no-files-found: error

      - name: Generate manifest.json
        run: |
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          cat > manifest.json << EOF
          {
            "app_id": "hello-world",
            "manifest": {
              "repository": "https://github.com/${{ github.repository }}",
              "commit": "${{ github.sha }}",
              "build_timestamp": "$TS",
              "build_attestation": {
                "issuer": "github.com",
                "reference": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              },
              "tee_target": "${{ steps.measurement.outputs.tee_target }}",
              "measurement": "${{ steps.measurement.outputs.measurement }}",
              "build_env": "github-actions"
            }
          }
          EOF

          echo "Generated manifest.json:"
          cat manifest.json

      - name: Publish manifest
        run: |
          TOKEN=$(curl -fsSH "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://thunderwind.net" | jq -r '.value')

          curl -fsSX POST https://api.thunderwind.net/api/v1/publish/manifest \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "Idempotency-Key: ${{ github.run_id }}-${{ github.run_attempt }}" \
            -d @manifest.json
